<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>회원가입 | 중고마켓</title>
    <th:block th:replace="fragments/header :: globalHead"></th:block>
    <link rel="stylesheet" href="/css/auth/signup.css" th:href="@{/css/auth/signup.css}">
</head>
<body class="signup-page">
<div th:replace="fragments/header :: siteHeader"></div>

<main class="signup-wrap">
    <div class="signup-card">
        <h1>회원가입</h1>
        <div class="signup-sub">간편하게 가입하고 안전하게 거래하세요.</div>

        <form id="signupForm" class="signup-form" novalidate>
            <!-- 이메일 -->
            <div class="signup-field">
                <label class="signup-label">이메일 주소 <small>로그인 ID로 사용돼요</small></label>
                <div class="signup-control">
                    <input type="email" id="email" placeholder="name@example.com" autocomplete="email"/>
                </div>
                <div class="signup-error" id="emailErr">올바른 이메일 형식을 입력해 주세요.</div>
            </div>

            <!-- 비밀번호 -->
            <div class="signup-field">
                <label class="signup-label">비밀번호 <small>8~32자, 영문/숫자/특수문자 중 2가지 이상</small></label>
                <div class="signup-control">
                    <input type="password" id="pw" placeholder="비밀번호를 입력하세요" autocomplete="new-password"/>
                    <button class="signup-showbtn" type="button" data-target="pw">보기</button>
                </div>
                <div class="signup-meter" aria-hidden="true">
                    <span id="m1"></span><span id="m2"></span><span id="m3"></span><span id="m4"></span>
                </div>
                <div class="signup-error" id="pwErr">비밀번호 규칙을 확인해 주세요.</div>
            </div>

            <!-- 비밀번호 확인 -->
            <div class="signup-field">
                <label class="signup-label">비밀번호 재입력</label>
                <div class="signup-control">
                    <input type="password" id="pw2" placeholder="비밀번호를 다시 입력하세요" autocomplete="new-password"/>
                    <button class="signup-showbtn" type="button" data-target="pw2">보기</button>
                </div>
                <div class="signup-error" id="pw2Err">비밀번호가 일치하지 않습니다.</div>
            </div>

            <!-- 이름 -->
            <div class="signup-field">
                <label class="signup-label">이름</label>
                <div class="signup-control">
                    <input type="text" id="name" placeholder="실명 입력" autocomplete="name"/>
                </div>
                <div class="signup-error" id="nameErr">이름을 입력해 주세요.</div>
            </div>

            <!-- 닉네임 -->
            <div class="signup-field">
                <label class="signup-label">닉네임 <small>거래 시 표시되는 이름</small></label>
                <div class="signup-control">
                    <input type="text" id="nick" placeholder="예: 레고수집가, 아이폰장인" autocomplete="nickname"/>
                </div>
                <div class="signup-hint">한글/영문/숫자, 2~15자</div>
                <div class="signup-error" id="nickErr">닉네임 형식을 확인해 주세요.</div>
            </div>

            <!-- 약관 동의 -->
            <div class="signup-field">
                <label class="signup-label">이용 약관</label>
                <label class="signup-agree">
                    <input type="checkbox" id="agree"/>
                    <span>개인정보 수집 및 이용, 서비스 이용약관에 동의합니다.</span>
                </label>
                <div class="signup-error" id="agreeErr">가입을 위해 약관에 동의해 주세요.</div>
            </div>
        </form>
    </div>
</main>

<!-- 고정 하단 액션 -->
<div class="signup-footer">
    <div class="signup-footer__inner">
        <button class="signup-action signup-action--ghost" type="button" onclick="history.back()">취소</button>
        <button class="signup-action signup-action--primary" id="submitBtn" disabled>가입하기</button>
    </div>
</div>

<div th:replace="fragments/footer :: siteFooter"></div>

<th:block th:replace="fragments/footer :: globalScripts"></th:block>
<script>
    $(function () {
        // showPopup('알러트');
        const $email = $('#email');
        const $pw = $('#pw'); // 비밀번호
        const $pw2 = $('#pw2'); // 비밀번호 재입력
        const $name = $('#name');
        const $nick = $('#nick');
        const $agree = $('#agree'); // 이용약관 동의
        const $submitBtn = $('#submitBtn');
        const $form = $('#signupForm');
        const $meters = $('#m1, #m2, #m3, #m4'); // 검증부분 스코어
        const errs = {
            email: $('#emailErr'),
            pw: $('#pwErr'),
            pw2: $('#pw2Err'),
            name: $('#nameErr'),
            nick: $('#nickErr'),
            agree: $('#agreeErr')
        };

        // 검증 규칙
        const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // 이메일 정규식
        const nickRx = /^[가-힣a-zA-Z0-9]{2,15}$/; // 한글, 숫자 2~15자

        $form.on('input change blur', validate);
        $submitBtn.on('click', handleSubmit);

        // 보기/숨기기
        $('.signup-showbtn').on('click', function () {
            const $btn = $(this);
            const targetId = $btn.data('target');
            const $input = $('#' + targetId);
            const isPw = $input.attr('type') === 'password';
            $input.attr('type', isPw ? 'text' : 'password');
            $btn.text(isPw ? '숨기기' : '보기');
        });

        /**
         * 인풋 하단에 에러메시지 노출
         * @param key string 엘리먼트 id
         * @param on boolean
         */
        function showErr(key, on) {
            errs[key].toggle(on);
        }

        function pwScore(v) {
            if (!v) return 0;
            let score = 0;
            if (v.length >= 8) score++;
            if (/[A-Z]/.test(v) || /[a-z]/.test(v)) score++;
            if (/\d/.test(v)) score++;
            if (/[^\w\s]/.test(v)) score++;
            if (v.length >= 12 && score >= 3) score++;
            return Math.min(4, Math.max(1, score));
        }

        /**
         * 비밀번호 하단 스코어 페인팅
         * @param score number 스코어점수(1~4)
         */
        function paintMeter(score) {
            $meters.each(function (index) {
                const $el = $(this);
                $el.removeClass();
                if (score >= index + 1) {
                    $el.addClass('on-' + score);
                }
            });
        }

        function resetForm() {
            if ($form.length) {
                $form[0].reset();
            }
            paintMeter(0);
            Object.keys(errs).forEach(key => showErr(key, false));
            $submitBtn.prop('disabled', true);
        }

        function showPopup(options) {
            if (window.Popup && typeof window.Popup.show === 'function') {
                window.Popup.show(options);
            } else {
                const msg = typeof options === 'string'
                    ? options
                    : options?.message || options?.description || '알림';
                alert(msg);
            }
        }

        function validate() {
            const rawEmail = $email.val() || '';
            const vEmail = rawEmail.trim();
            const okEmail = emailRx.test(vEmail);
            showErr('email', !okEmail && rawEmail !== '');

            const vPw = $pw.val() || '';
            const score = pwScore(vPw);
            paintMeter(vPw ? score : 0);

            const okPw = vPw.length >= 8 && score >= 2;
            showErr('pw', !okPw && vPw !== '');

            const vPw2 = $pw2.val() || '';
            const okPw2 = vPw2 !== '' && vPw2 === vPw;
            showErr('pw2', !okPw2 && vPw2 !== '');

            const rawName = $name.val() || '';
            const okName = rawName.trim().length > 0;
            showErr('name', !okName && rawName !== '');

            const rawNick = $nick.val() || '';
            const okNick = nickRx.test(rawNick.trim());
            showErr('nick', !okNick && rawNick !== '');

            const okAgree = $agree.prop('checked');
            showErr('agree', !okAgree);

            const allOk = okEmail && okPw && okPw2 && okName && okNick && okAgree;
            $submitBtn.prop('disabled', !allOk);
            return allOk;
        }

        async function handleSubmit(event) {
            if (event) {
                event.preventDefault();
            }
            if (!validate()) {
                return;
            }

            const payload = {
                email: ($email.val() || '').trim(),
                password: $pw.val() || '',
                name: ($name.val() || '').trim(),
                nickname: ($nick.val() || '').trim(),
                agree: $agree.prop('checked'),
                isAdmin: false
            };

            try {
                if (!window.apiService) {
                    throw new Error('HTTP 클라이언트가 초기화되지 않았습니다.');
                }

                $submitBtn.prop('disabled', true);
                const data = await window.apiService.post('/api/auth/signup', payload);

                console.log('[signup success]', data);

                showPopup({
                    title: '가입 완료',
                    message: '중고마켓에 가입해 주셔서 감사합니다.',
                    actions: [
                        {label: '닫기', variant: 'secondary'},
                        {
                            label: '홈으로',
                            variant: 'primary',
                            handler: () => {
                                window.location.href = '/';
                            }
                        },
                    ]
                });

                resetForm();
            } catch (error) {
                console.error('[signup error]', error);
                const message = error?.message || '회원가입 처리 중 오류가 발생했습니다.';
                showPopup({
                    title: '회원가입 실패',
                    message,
                    actions: [
                        {label: '확인', variant: 'primary'}
                    ]
                });
                $submitBtn.prop('disabled', false);
                validate();
            }
        }
    });
</script>
</body>
</html>
